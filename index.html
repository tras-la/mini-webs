<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#e6deca" />
    <meta name="color-scheme" content="light only" />
    <title>Cre√° tu sitio web en Trasla</title>
    <meta name="description" content="Cre√° tu mini sitio web gratis en Trasla." />
    <meta property="og:title" content="Mi Sitio Web en Trasla" />
    <meta property="og:description" content="Cre√° tu mini sitio web gratis en Trasla." />
    <meta property="og:locale" content="es-AR" />

    <style>
      :root {
        --primary: #3d3f20;
        --primary-light: #3d3f20;
        --secondary: #000;
        --danger: #d32f2f;
        --text: #222;
        --text-light: #666;
        --bg: #e6deca;
        --white: #fafafa;
        --border: #ccc;
        --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        --radius: 10px;
        --bg-color: var(--white);
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: var(--bg-color);
        color: var(--text);
        margin: 0;
        padding: 2rem;
        line-height: 1.5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 2rem;
      }

      header {
        text-align: center;
        margin-bottom: 1rem;
      }

      h1 {
        color: var(--primary);
        margin-bottom: 0.5rem;
      }

      .subtitle {
        color: var(--text-light);
        font-size: 1.1rem;
      }

      .mini-site {
        background: var(--white);
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: var(--shadow);
        text-align: center;
        transition: all 0.3s ease;
        min-height: 500px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        background-color: var(--bg);
      }

      .mini-site.editing {
        box-shadow: 0 0 0 3px var(--primary);
      }

      .profile-image-container {
        position: relative;
        width: 120px;
        height: 120px;
        margin: 0 auto 1rem;
      }

      .mini-site img {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid var(--primary);
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .mini-site img:hover {
        opacity: 0.8;
      }

      .profile-placeholder {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 3px solid var(--primary);
        background: #f0f0f0;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 2.5rem;
        color: var(--primary);
      }

      .profile-placeholder:hover {
        background: #e0e0e0;
      }

      .inline-input {
        background: transparent;
        border: 1px solid transparent;
        border-radius: 4px;
        padding: 0.5rem;
        width: 100%;
        font-family: inherit;
        color: inherit;
        transition: all 0.2s;
      }

      .inline-input:hover, .inline-input:focus {
        background: rgba(0, 0, 0, 0.05);
      }

      .inline-input:focus {
        border-color: var(--primary);
        outline: none;
        box-shadow: 0 0 0 2px rgba(129, 61, 156, 0.2);
      }

      #display-name {
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-align: center;
      }

      .url-claimer {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 2rem;
        font-size: 1.1rem;
        color: var(--text-light);
        background: rgba(255, 255, 255, 0.5);
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        width: fit-content;
        border: 1px solid transparent;
        transition: all 0.3s ease;
        cursor: text;
      }

      .url-claimer:hover, .url-claimer:focus-within {
        background: var(--white);
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        border-color: var(--border);
      }

      .url-prefix {
        color: var(--text-light);
        font-weight: 400;
        white-space: nowrap;
        user-select: none;
      }

      #username {
        background: transparent;
        border: none;
        font-size: inherit;
        font-weight: 700;
        color: var(--text);
        padding: 0 0 0 2px;
        margin: 0;
        width: 10ch;
        min-width: 50px;
        outline: none;
        font-family: inherit;
      }
      
      #username::placeholder {
        color: var(--text-light);
        opacity: 0.5;
        font-weight: 400;
      }

      #description {
        text-align: center;
        resize: none;
        min-height: 80px;
        margin-bottom: 2rem;
        line-height: 1.6;
        font-family: inherit;
      }

      /* Link Styles */
      .links {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-bottom: 2rem;
        width: 100%;
      }

      .link-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        width: 100%;
        background: rgba(255, 255, 255, 0.5);
        border: 1px solid var(--primary);
        border-radius: 30px; /* Pill shape */
        padding: 0.5rem 0.75rem 0.5rem 0.5rem;
        transition: transform 0.2s, box-shadow 0.2s;
        position: relative;
      }

      .link-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .link-thumbnail {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        object-fit: cover;
        flex-shrink: 0;
        background-color: rgba(0,0,0,0.05);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        overflow: hidden;
      }
      
      .link-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .link-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        min-width: 0;
        text-align: center; /* Centered text like Linktree */
      }

      .link-label {
        font-weight: 600;
        color: var(--text);
        text-decoration: none;
        display: block;
        width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      .link-url-preview {
        font-size: 0.75rem;
        color: var(--text-light);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .link-actions {
        display: flex;
        gap: 0.25rem;
        opacity: 0.6;
        transition: opacity 0.2s;
      }
      
      .link-item:hover .link-actions {
        opacity: 1;
      }

      /* Edit Mode Styles */
      .link-edit-container {
        background: rgba(0,0,0,0.03);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 1rem;
        width: 100%;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      }

      .link-edit-row {
        display: flex;
        gap: 0.75rem;
        align-items: center;
      }
      
      .link-edit-inputs {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .link-input {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 0.9rem;
        background-color: var(--bg);
      }
      
      .link-input:focus {
        border-color: var(--primary);
        outline: none;
      }
      
      .upload-btn-wrapper {
        position: relative;
        overflow: hidden;
        display: inline-block;
        cursor: pointer;
      }
      
      .thumbnail-upload-preview {
        width: 60px;
        height: 60px;
        border-radius: 8px;
        border: 2px dashed var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        overflow: hidden;
        background-color: var(--bg);
        transition: all 0.2s;
      }
      
      .thumbnail-upload-preview:hover {
        border-color: var(--primary);
        background: #f0f0f0;
      }
      
      .thumbnail-upload-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0.4rem;
        border-radius: 50%;
        transition: background 0.2s;
        color: var(--text-light);
      }

      .icon-btn:hover {
        background-color: rgba(0,0,0,0.05);
        color: var(--primary);
      }

      .add-link-container {
        margin-top: 1rem;
      }
      
      .add-link-btn {
        width: 100%;
        padding: 1rem;
        background: transparent;
        border: 2px dashed var(--border);
        border-radius: 30px;
        color: var(--text-light);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .add-link-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        background: rgba(0,0,0,0.02);
      }

      /* Main Actions */
      .actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1.5rem;
        flex-wrap: wrap;
      }

      .primary-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        background-color: var(--primary) !important; /* Force color */
        color: var(--white) !important;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 30px; /* Pill shape */
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        min-width: 150px;
      }

      .primary-btn:hover {
        background-color: var(--primary-light) !important;
        opacity: 0.9;
      }

      .primary-btn:active {
        transform: translateY(1px);
      }

      .primary-btn:disabled {
        background-color: var(--text-light) !important;
        cursor: not-allowed;
        opacity: 0.7;
      }

      /* Color Picker Styles */
      .color-picker-container {
        margin-top: 2rem;
        padding: 1rem;
        background: rgba(0,0,0,0.03);
        border-radius: 12px;
      }

      .color-picker-group {
        display: flex;
        justify-content: center;
        gap: 2rem;
      }

      .color-picker-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.5rem;
      }

      .color-picker-item label {
        font-size: 0.9rem;
        color: var(--text-light);
        font-weight: 500;
      }

      .color-input-wrapper {
        position: relative;
        width: 40px;
        height: 40px;
        cursor: pointer;
      }

      .color-input-wrapper input[type="color"] {
        position: absolute;
        opacity: 0;
        width: 100%;
        height: 100%;
        cursor: pointer;
        z-index: 2;
        inset: 0;
      }

      .color-circle {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        border: 2px solid var(--white);
        box-shadow: 0 0 0 1px var(--border);
        transition: transform 0.2s;
      }

      .color-input-wrapper:hover .color-circle {
        transform: scale(1.1);
      }

      /* Hide file input visually but keep it functional */
      #profile-image-input {
        display: none;
      }
      /* Notification Styles */
      .notification {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100px);
        background: var(--white);
        padding: 1rem 1.5rem;
        border-radius: 50px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        z-index: 1000;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        font-weight: 500;
        border: 1px solid var(--border);
        min-width: 300px;
        justify-content: center;
      }

      .notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }

      .notification.success {
        border-left: 4px solid #4caf50;
      }

      .notification.error {
        border-left: 4px solid var(--danger);
      }
      
      #notification-icon {
        font-size: 1.2rem;
      }

      /* Dialog Styles */
      dialog {
        border: none;
        border-radius: var(--radius);
        padding: 2rem;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        max-width: 400px;
        width: 90%;
        background: var(--white);
        color: var(--text);
      }
      
      dialog::backdrop {
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
      }
      
      .dialog-content {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
        text-align: center;
      }
      
      .dialog-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
      }
      
      .dialog-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        font-size: 1rem;
        font-family: inherit;
      }
      
      .dialog-input:focus {
        border-color: var(--primary);
        outline: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Cre√° tu mini sitio web en Trasla</h1>
        <p class="subtitle">Tu lugar en la web para mostrar lo que hac√©s</p>
      </header>

      <form id="main-form">
        <div class="url-claimer" onclick="document.getElementById('username').focus()">
          <span class="url-prefix">trasla.com.ar/</span>
          <input type="text" id="username" placeholder="tunombre" name="username" required autocomplete="off" />
        </div>

        <div class="mini-site" id="mini-site">
          <div class="profile-image-container">
            <div class="profile-placeholder" id="profile-placeholder">üë§</div>
            <img src="" alt="Tu imagen de perfil" id="profile-image" style="display: none" />
            <input type="file" id="profile-image-input" accept="image/*" name="profile-image" />
          </div>

          <input type="text" id="display-name" class="inline-input" placeholder="Nombre del sitio" name="displayName" required />
          


          <textarea id="description" class="inline-input" placeholder="Agreg√° una descripci√≥n sobre tu sitio" name="description"></textarea>

          <div class="links" id="links-container"></div>
          
          <!-- Add Link Section -->
          <div class="add-link-container" id="add-link-container">
            <button type="button" id="show-add-link-btn" class="add-link-btn">+ Agregar enlace</button>
            
            <div id="add-link-form" class="link-edit-container" style="display: none;">
              <div class="link-edit-row">
                <div class="upload-btn-wrapper">
                  <div class="thumbnail-upload-preview" id="new-link-preview" title="Agregar imagen">
                    <span style="font-size: 1.5rem;">üì∑</span>
                  </div>
                  <input type="file" id="new-link-image" accept="image/*" style="display: none;" />
                </div>
                <div class="link-edit-inputs">
                  <input type="text" id="new-link-name" class="link-input" placeholder="T√≠tulo del enlace" />
                  <input type="url" id="new-link-url" class="link-input" placeholder="URL (https://...)" />
                </div>
              </div>
              <div class="modal-actions" style="margin-top: 0; padding-top: 0;">
                <button type="button" id="cancel-add-btn" class="icon-btn cancel" title="Cancelar">‚ùå</button>
                <button type="button" id="save-new-btn" class="icon-btn save" title="Guardar">üíæ</button>
              </div>
            </div>
          </div>
          <div class="color-picker-container">
            <div class="color-picker-group">
              <div class="color-picker-item">
                <label for="accent-color">Acento</label>
                <div class="color-input-wrapper">
                  <input type="color" id="accent-color" value="#3d3f20" name="accent-color" />
                  <div class="color-circle" id="accent-sample" style="background-color: #3d3f20"></div>
                </div>
              </div>

              <div class="color-picker-item">
                <label for="bg-color">Fondo</label>
                <div class="color-input-wrapper">
                  <input type="color" id="bg-color" value="#e6deca" name="bg-color" />
                  <div class="color-circle" id="bg-sample" style="background-color: #e6deca"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button type="submit" id="publish-btn" class="primary-btn">
              <span id="publish-text">Crear Sitio</span>
              <span id="publish-spinner" class="spinner" style="display: none"></span>
            </button>
          </div>
        </div>


      </form>
    </div>
    <!-- Notification -->
    <div class="notification" id="notification">
      <span id="notification-icon">‚úÖ</span>
      <span id="notification-message">Sitio publicado exitosamente</span>
    </div>

    <!-- Email Dialog -->
    <dialog id="email-dialog">
      <div class="dialog-content">
        <h3 style="margin: 0; color: var(--primary);">¬°Casi listo!</h3>
        <p style="margin: 0; color: var(--text-light);">Ingres√° tu email para recibir el enlace de edici√≥n. Lo necesitar√°s para hacer cambios en el futuro.</p>
        <input type="email" id="user-email" class="dialog-input" placeholder="tu@email.com" required />
        <div class="dialog-buttons">
          <button type="button" id="cancel-email-btn" class="add-link-btn" style="border: 1px solid var(--border);">Cancelar</button>
          <button type="button" id="confirm-publish-btn" class="primary-btn">Publicar Sitio</button>
        </div>
      </div>
    </dialog>

    <script type="module">
      import { compressImageBlob, convertBlobsToBase64, convertBlobToDataURI } from "./utils.js";

      // DOM elements
      const miniSite = document.getElementById("mini-site");
      const profileImage = document.getElementById("profile-image");
      const profilePlaceholder = document.getElementById("profile-placeholder");
      const displayName = document.getElementById("display-name");
      const username = document.getElementById("username");
      const description = document.getElementById("description");
      const linksContainer = document.getElementById("links-container");
      const form = document.getElementById("main-form");

      // Color pickers
      const accentColorPicker = document.getElementById("accent-color");
      const bgColorPicker = document.getElementById("bg-color");
      const accentSample = document.getElementById("accent-sample");
      const bgSample = document.getElementById("bg-sample");

      // Add Link Container
      const addLinkContainer = document.getElementById("add-link-container");

      // Buttons
      const publishBtn = document.getElementById("publish-btn");
      const publishText = document.getElementById("publish-text");
      const publishSpinner = document.getElementById("publish-spinner");
      const profileImageInput = document.getElementById("profile-image-input");

      // Notification
      const notification = document.getElementById("notification");
      const notificationIcon = document.getElementById("notification-icon");
      const notificationMessage = document.getElementById("notification-message");

      // Email Dialog Elements
      const emailDialog = document.getElementById("email-dialog");
      const userEmailInput = document.getElementById("user-email");
      const cancelEmailBtn = document.getElementById("cancel-email-btn");
      const confirmPublishBtn = document.getElementById("confirm-publish-btn");

      // Data storage
      let siteData = (window.siteData = {
        displayName: "",
        username: "",
        description: "",
        profileImage: "",
        accentColor: "#3d3f20",
        bgColor: "#e6deca",
        email: "",
        links: [],
      });

      const searchParams = new URLSearchParams(location.search);
      if (searchParams.has("test")) {
        siteData.displayName = "Trasla Eventos";
        siteData.username = "traslaeventos";
        siteData.description = "Organizamos los mejores eventos para vos.";
        siteData.accentColor = "#3d3f20";
        siteData.bgColor = "#e6deca";
        siteData.links = [
          { label: "Instagram", url: "https://instagram.com/traslaeventos" },
          { label: "Facebook", url: "https://facebook.com/traslaeventos" },
          { label: "Mi portfolio", url: "https://tuportfolio.com" },
        ];
        siteData.profileImage = ""; // base64 minimal example
      }

      // Initialize input values from siteData
      function initializeInputs() {
        displayName.value = siteData.displayName;
        username.value = siteData.username;
        description.value = siteData.description;
        accentColorPicker.value = siteData.accentColor;
        bgColorPicker.value = siteData.bgColor;
        
        // Trigger input events to update UI
        accentColorPicker.dispatchEvent(new Event('input'));
        bgColorPicker.dispatchEvent(new Event('input'));
        
        if (siteData.profileImage) {
          profileImage.src = siteData.profileImage;
          profileImage.style.display = "block";
          profilePlaceholder.style.display = "none";
        }
        
        adjustUsernameWidth(username);
      }

      let editingLinkIndex = -1;
      // let isAddingLink = false; // Removed as we use static form visibility now

      // API endpoint placeholder
      const PUBLISH_ENDPOINT =
        "https://script.google.com/macros/s/AKfycbwWCl32hVI3E5KDv5i5TM4Hhmzz9YuiI1DF-j5NKVN8dDs9EqGYMUkoJAROYx-PRJkYvg/exec";

      // Event listeners for inline inputs
      displayName.addEventListener("input", (e) => {
        siteData.displayName = e.target.value;
      });

      username.addEventListener("input", (e) => {
        // Simple validation: allow only alphanumeric, underscore, and dash
        const validValue = e.target.value.replace(/[^a-zA-Z0-9_-]/g, "");
        if (validValue !== e.target.value) {
          e.target.value = validValue;
        }
        siteData.username = validValue;
        adjustUsernameWidth(e.target);
      });

      function adjustUsernameWidth(input) {
        const length = input.value.length || input.placeholder.length;
        input.style.width = Math.max(length, 4) + "ch";
      }
      
      // Initialize width
      adjustUsernameWidth(username);

      // Auto-grow textarea
      function adjustTextareaHeight(textarea) {
        textarea.style.height = "auto";
        textarea.style.height = textarea.scrollHeight + 3 + "px";
      }

      description.addEventListener("input", (e) => {
        siteData.description = e.target.value;
        adjustTextareaHeight(e.target);
      });

      // Initialize textarea height
      adjustTextareaHeight(description);

      // Image upload handling
      profilePlaceholder.addEventListener("click", () => {
        profileImageInput.click();
      });

      profileImage.addEventListener("click", () => {
        profileImageInput.click();
      });

      profileImageInput.addEventListener("change", function () {
        if (this.files && this.files[0]) {
          const file = this.files[0];
          const reader = new FileReader();
          reader.onload = async function (e) {
            const compressedBlob = await compressImageBlob(file);
            const base64 = await convertBlobToDataURI(compressedBlob);
            profileImage.src = base64;
            profileImage.style.display = "block";
            profilePlaceholder.style.display = "none";
            siteData.profileImage = base64;
            
            // Reset input so same file can be selected again if needed
            profileImageInput.value = "";
          };
          reader.readAsDataURL(file);
        }
      });

      // Color picker event listeners
      accentColorPicker.addEventListener("input", (e) => {
        siteData.accentColor = e.target.value;
        updateColors();
      });

      bgColorPicker.addEventListener("input", (e) => {
        siteData.bgColor = e.target.value;
        updateColors();
      });

      // Avoid form submission on Enter key
      document.querySelectorAll("form input").forEach((input) => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
          }
        });
      });

      // Publish functionality
      form.addEventListener("submit", function (event) {
        event.preventDefault();
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }
        // Validate required fields
        if (!siteData.displayName || !siteData.username) {
          showNotification("Por favor, completa al menos tu nombre y usuario", "error");
          return;
        }

        if (!siteData.profileImage) {
          showNotification("Por favor, agrega una imagen de perfil", "error");
          return;
        }

        if (siteData.links.length === 0) {
          showNotification("Por favor, agrega al menos un enlace", "error");
          return;
        }

        // Show email dialog
        userEmailInput.value = siteData.email || "";
        userEmailInput.style.borderColor = "var(--border)";
        emailDialog.showModal();
      });

      // Dialog Event Listeners
      cancelEmailBtn.addEventListener("click", () => {
        emailDialog.close();
      });

      confirmPublishBtn.addEventListener("click", async () => {
        const email = userEmailInput.value.trim();
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        
        if (!email || !emailRegex.test(email)) {
          userEmailInput.style.borderColor = "var(--danger)";
          showNotification("Por favor, ingresa un email v√°lido", "error");
          return;
        }
        
        siteData.email = email;
        emailDialog.close();
        await performPublish();
      });

      async function performPublish() {
        // Show loading state
        publishBtn.disabled = true;
        publishText.textContent = "Publicando...";
        publishSpinner.style.display = "inline-block";

        try {
          // Prepare data for API
          const publishData = {
            displayName: siteData.displayName,
            username: siteData.username,
            description: siteData.description,
            profileImage: siteData.profileImage,
            accentColor: siteData.accentColor,
            bgColor: siteData.bgColor,
            email: siteData.email,
            links: siteData.links,
          };

          // Send data to API
          const response = await publishToAPI(publishData);
          console.info(response);

          if (!response.success) {
            showNotification(response.metadata.message, "error");
            return;
          }

          // Show success message
          showNotification("¬°Tu sitio ha sido publicado exitosamente! Ten√©s el link para editar el sitio en tu email.", "success");
          setTimeout(() => {
            showNotification("Redirigiendo al sitio...", "success");
            location.href = `https://trasla.com.ar/${siteData.username}`;
          }, 2000);
        } catch (error) {
          // Show error message
          console.error("Error publishing site:", error);
          showNotification("Error al publicar el sitio. Intenta nuevamente.", "error");
        } finally {
          // Reset button state
          publishBtn.disabled = false;
          publishText.textContent = "Crear Sitio";
          publishSpinner.style.display = "none";
        }
      }

      // Helper functions
      function processUrl(url) {
        url = url.trim();
        if (!url) return null;
        // If it doesn't start with http:// or https://, prepend https://
        if (!/^https?:\/\//i.test(url)) {
          url = 'https://' + url;
        }
        try {
          new URL(url);
          return url;
        } catch (e) {
          return null;
        }
      }

      function renderLinks() {
        linksContainer.innerHTML = "";

        siteData.links.forEach((link, index) => {
          const linkItem = document.createElement("div");
          
          if (editingLinkIndex === index) {
            linkItem.className = "link-edit-container";
            linkItem.innerHTML = `
              <div class="link-edit-row">
                <div class="upload-btn-wrapper">
                  <div class="thumbnail-upload-preview" title="Cambiar imagen">
                    ${link.image ? `<img src="${link.image}" />` : '<span style="font-size: 1.5rem;">üì∑</span>'}
                  </div>
                  <input type="file" class="link-image-input" accept="image/*" style="display: none;" />
                </div>
                <div class="link-edit-inputs">
                  <input type="text" class="link-input edit-name" value="${link.label}" placeholder="T√≠tulo del enlace" />
                  <input type="url" class="link-input edit-url" value="${link.url}" placeholder="URL (https://...)" />
                </div>
              </div>
              <div class="modal-actions" style="margin-top: 0; padding-top: 0;">
                <button type="button" class="icon-btn cancel" title="Cancelar">‚ùå</button>
                <button type="button" class="icon-btn save" title="Guardar">üíæ</button>
              </div>
            `;

            const saveBtn = linkItem.querySelector(".save");
            const cancelBtn = linkItem.querySelector(".cancel");
            const nameInput = linkItem.querySelector(".edit-name");
            const urlInput = linkItem.querySelector(".edit-url");
            const imageInput = linkItem.querySelector(".link-image-input");
            const imagePreview = linkItem.querySelector(".thumbnail-upload-preview");
            
            let currentImage = link.image;

            // Image upload handler
            imagePreview.addEventListener("click", () => imageInput.click());
            imageInput.addEventListener("change", async (e) => {
              if (e.target.files && e.target.files[0]) {
                const file = e.target.files[0];
                const compressed = await compressImageBlob(file, 128);
                const base64 = await convertBlobToDataURI(compressed);
                currentImage = base64;
                imagePreview.innerHTML = `<img src="${base64}" />`;
              }
            });

            saveBtn.addEventListener("click", () => {
              const newName = nameInput.value.trim();
              const rawUrl = urlInput.value.trim();
              const validUrl = processUrl(rawUrl);
              
              if (newName && validUrl) {
                siteData.links[index] = { ...link, label: newName, url: validUrl, image: currentImage };
                editingLinkIndex = -1;
                renderLinks();
              } else {
                if (!newName) nameInput.style.borderColor = "var(--danger)";
                if (!validUrl) {
                  urlInput.style.borderColor = "var(--danger)";
                  showNotification("URL inv√°lida", "error");
                }
              }
            });

            cancelBtn.addEventListener("click", () => {
              editingLinkIndex = -1;
              renderLinks();
            });

            // Prevent form submission on Enter in edit fields
            [nameInput, urlInput].forEach(input => {
              input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                  e.preventDefault();
                  saveBtn.click(); // Trigger save on Enter
                }
              });
            });

          } else {
            linkItem.className = "link-item";
            linkItem.innerHTML = `
              <div class="link-thumbnail">
                ${link.image ? `<img src="${link.image}" alt="${link.label}" />` : 'üîó'}
              </div>
              <div class="link-content">
                <a href="${link.url}" class="link-label" target="_blank" onclick="event.stopPropagation(); return false;">${link.label}</a>
                <span class="link-url-preview">${new URL(link.url).hostname}</span>
              </div>
              <div class="link-actions">
                <button type="button" class="icon-btn edit" title="Editar">‚úèÔ∏è</button>
                <button type="button" class="icon-btn remove" title="Eliminar">üóëÔ∏è</button>
              </div>
            `;

            linkItem.querySelector(".edit").addEventListener("click", () => {
              editingLinkIndex = index;
              resetAddLinkForm(); // Close add form if open
              renderLinks();
            });

            linkItem.querySelector(".remove").addEventListener("click", () => {
              if(confirm("¬øEst√°s seguro de eliminar este enlace?")) {
                siteData.links.splice(index, 1);
                renderLinks();
              }
            });
          }

          linksContainer.appendChild(linkItem);
        });

        // renderAddLinkSection(); // No longer needed
      }

      // Add Link Form Elements
      const showAddLinkBtn = document.getElementById("show-add-link-btn");
      const addLinkForm = document.getElementById("add-link-form");
      const saveNewBtn = document.getElementById("save-new-btn");
      const cancelAddBtn = document.getElementById("cancel-add-btn");
      const newLinkName = document.getElementById("new-link-name");
      const newLinkUrl = document.getElementById("new-link-url");
      const newLinkImage = document.getElementById("new-link-image");
      const newLinkPreview = document.getElementById("new-link-preview");
      
      let newLinkImageData = null;

      // Add Link Event Listeners
      showAddLinkBtn.addEventListener("click", () => {
        showAddLinkBtn.style.display = "none";
        addLinkForm.style.display = "flex";
        editingLinkIndex = -1; // Close other edits
        renderLinks();
        setTimeout(() => newLinkName.focus(), 50);
      });

      cancelAddBtn.addEventListener("click", () => {
        resetAddLinkForm();
      });

      function resetAddLinkForm() {
        showAddLinkBtn.style.display = "block";
        addLinkForm.style.display = "none";
        newLinkName.value = "";
        newLinkUrl.value = "";
        newLinkImage.value = "";
        newLinkImageData = null;
        newLinkPreview.innerHTML = '<span style="font-size: 1.5rem;">üì∑</span>';
        newLinkName.style.borderColor = "var(--border)";
        newLinkUrl.style.borderColor = "var(--border)";
      }

      // Image upload for new link
      newLinkPreview.addEventListener("click", () => newLinkImage.click());
      newLinkImage.addEventListener("change", async (e) => {
        if (e.target.files && e.target.files[0]) {
          const file = e.target.files[0];
          const compressed = await compressImageBlob(file, 128);
          const base64 = await convertBlobToDataURI(compressed);
          newLinkImageData = base64;
          newLinkPreview.innerHTML = `<img src="${base64}" />`;
        }
      });

      // Save new link
      function saveNewLink() {
        const name = newLinkName.value.trim();
        const rawUrl = newLinkUrl.value.trim();
        const validUrl = processUrl(rawUrl);

        if (name && validUrl) {
          siteData.links.push({ label: name, url: validUrl, image: newLinkImageData });
          renderLinks();
          resetAddLinkForm();
        } else {
           if (!name) newLinkName.style.borderColor = "var(--danger)";
           if (!validUrl) {
             newLinkUrl.style.borderColor = "var(--danger)";
             showNotification("URL inv√°lida", "error");
           }
        }
      }

      saveNewBtn.addEventListener("click", saveNewLink);

      // Enter key support for new link form
      [newLinkName, newLinkUrl].forEach(input => {
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            saveNewLink();
          }
          e.target.style.borderColor = "var(--border)";
        });
      });

      function renderAddLinkSection() {
        // This function is now deprecated as the form is static, 
        // but we keep it empty or remove calls to it to avoid errors if called elsewhere.
      }

      // Update colors based on user selection
      function updateColors() {
        // Update CSS custom properties
        document.documentElement.style.setProperty("--primary", siteData.accentColor);
        document.documentElement.style.setProperty("--primary-light", lightenColor(siteData.accentColor, 20));
        document.documentElement.style.setProperty("--bg", siteData.bgColor);

        // Update the mini-site background only
        miniSite.style.backgroundColor = siteData.bgColor;

        // Update profile image border and placeholder
        profileImage.style.borderColor = siteData.accentColor;
        profilePlaceholder.style.borderColor = siteData.accentColor;
        profilePlaceholder.style.color = siteData.accentColor;
        
        // Update color picker samples
        accentSample.style.backgroundColor = siteData.accentColor;
        bgSample.style.backgroundColor = siteData.bgColor;
      }

      // Helper function to lighten a color
      function lightenColor(color, percent) {
        const num = parseInt(color.replace("#", ""), 16),
          amt = Math.round(2.55 * percent),
          R = (num >> 16) + amt,
          G = ((num >> 8) & 0x00ff) + amt,
          B = (num & 0x0000ff) + amt;

        return (
          "#" +
          (
            0x1000000 +
            (R < 255 ? (R < 1 ? 0 : R) : 255) * 0x10000 +
            (G < 255 ? (G < 1 ? 0 : G) : 255) * 0x100 +
            (B < 255 ? (B < 1 ? 0 : B) : 255)
          )
            .toString(16)
            .slice(1)
        );
      }

      // API publishing function
      async function publishToAPI(data) {
        // Replace PUBLISH_ENDPOINT with your actual API endpoint
        const endpoint = `${PUBLISH_ENDPOINT}?endpoint=create`;

        if (endpoint === "YOUR_API_ENDPOINT_HERE") {
          // Simulate API call for demonstration
          return new Promise((resolve) => {
            setTimeout(() => {
              console.log("Data to be sent to API:", JSON.stringify(data, null, 2));
              resolve({ success: true, id: "demo-site-id" });
            }, 1500);
          });
        }

        // Actual API call when endpoint is provided
        const response = await fetch(endpoint, {
          method: "POST",
          redirect: "follow",
          headers: {
            "Content-Type": "text/plain;charset=UTF-8",
          },
          body: JSON.stringify(data),
        });

        if (!response.ok) {
          throw new Error(`API error: ${response.status}`);
        }

        return response.json();
      }

      // Notification function
      function showNotification(message, type = "success") {
        notificationMessage.textContent = message;

        if (type === "success") {
          notification.className = "notification success";
          notificationIcon.textContent = "‚úÖ";
        } else {
          notification.className = "notification error";
          notificationIcon.textContent = "‚ùå";
        }

        notification.classList.add("show");

        setTimeout(() => {
          notification.classList.remove("show");
        }, 5000);
      }

      // Initialize the page
      initializeInputs();
      renderLinks();
      updateColors();
    </script>
  </body>
</html>
